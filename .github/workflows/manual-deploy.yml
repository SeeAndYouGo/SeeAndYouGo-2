name: SeeAndYouGo Manual Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'ë°°í¬ ëŒ€ìƒ ì„ íƒ'
        required: true
        type: choice
        options:
          - all
          - backend
          - frontend

jobs:
  build-backend:
    if: ${{ inputs.deploy_target == 'all' || inputs.deploy_target == 'backend' }}
    runs-on: ubuntu-latest
    steps:
      - name: "[Backend] ì½”ë“œ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v3

      - name: "[Backend] JDK 11 ì„¤ì •"
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: "[Backend] Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬"
        run: chmod +x backend/gradlew

      - name: "[Backend] í™˜ê²½ íŒŒì¼ ì¤€ë¹„"
        run: |
          cd backend/src/main/resources
          echo "${{ secrets.APPLICATION_YML }}" > application.yml
          echo "${{ secrets.APPLICATION_PROD_YML }}" > application-prod.yaml
          echo "${{ secrets.KEY_YML }}" > key.yml
        shell: bash

      - name: "[Backend] Gradle ë¹Œë“œ"
        run: |
          cd backend
          ./gradlew clean bootJar

      - name: "[Backend] Docker ì´ë¯¸ì§€ ë¹Œë“œ"
        run: |
          cd backend
          docker build \
            -t seeandyougo-backend:${{ github.sha }} \
            -t seeandyougo-backend:latest \
            .

      # âœ… gzip â†’ tarë¡œ ë³€ê²½
      - name: "[Backend] Docker ì´ë¯¸ì§€ ì €ì¥"
        run: |
          docker save seeandyougo-backend:latest > backend-image.tar

      - name: "[Backend] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ"
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar
          retention-days: 1

  build-frontend:
    if: ${{ inputs.deploy_target == 'all' || inputs.deploy_target == 'frontend' }}
    runs-on: ubuntu-latest
    steps:
      - name: "[Frontend] ì½”ë“œ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v3

      - name: "[Frontend] í™˜ê²½ íŒŒì¼ ì¤€ë¹„"
        run: |
          cd frontend
          echo "${{ secrets.FRONTEND_ENV }}" > .env
        shell: bash

      - name: "[Frontend] Docker ì´ë¯¸ì§€ ë¹Œë“œ"
        run: |
          docker build \
            -t seeandyougo-frontend:${{ github.sha }} \
            -t seeandyougo-frontend:latest \
            -f Dockerfile \
            .

      # âœ… gzip â†’ tarë¡œ ë³€ê²½
      - name: "[Frontend] Docker ì´ë¯¸ì§€ ì €ì¥"
        run: |
          docker save seeandyougo-frontend:latest > frontend-image.tar

      - name: "[Frontend] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ"
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar
          retention-days: 1

  deploy:
    needs: [build-backend, build-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "[ë°°í¬] Backend ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ"
        if: ${{ inputs.deploy_target == 'all' || inputs.deploy_target == 'backend' }}
        uses: actions/download-artifact@v4
        with:
          name: backend-image
        continue-on-error: true

      - name: "[ë°°í¬] Frontend ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ"
        if: ${{ inputs.deploy_target == 'all' || inputs.deploy_target == 'frontend' }}
        uses: actions/download-artifact@v4
        with:
          name: frontend-image
        continue-on-error: true

      - name: "[ë°°í¬] ì„œë²„ë¡œ íŒŒì¼ ì „ì†¡"
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "*.tar"
          target: "/tmp/seeandyougo-deploy"
          timeout: 30m
          tar_exec: false    # ì´ì¤‘ ì••ì¶•/í•´ì œ ë¹„í™œì„±í™”

      - name: "[ë°°í¬] ì„œë²„ì—ì„œ ë°°í¬ ì‹¤í–‰"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 30m
          script: |
            set -e
            cd /tmp/seeandyougo-deploy
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ SeeAndYouGo ë°°í¬ ì‹œì‘"
            echo "ğŸ“¦ ë°°í¬ ëŒ€ìƒ: ${{ inputs.deploy_target }}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Backend ë°°í¬
            if [ -f backend-image.tar ]; then
              echo ""
              echo "[Backend] Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
              docker load < backend-image.tar > /dev/null 2>&1
              
              echo "[Backend] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
              docker stop seeandyougo > /dev/null 2>&1 || true
              docker rm seeandyougo > /dev/null 2>&1 || true
              
              echo "[Backend] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
              docker run -d \
                --name seeandyougo \
                --restart always \
                --network backbone \
                -p 8080:8080 \
                -e TZ=Asia/Seoul \
                seeandyougo-backend:latest > /dev/null 2>&1
              
              echo "âœ… [Backend] ë°°í¬ ì™„ë£Œ"
            fi
            
            # Frontend ë°°í¬
            if [ -f frontend-image.tar ]; then
              echo ""
              echo "[Frontend] Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
              docker load < frontend-image.tar > /dev/null 2>&1
              
              echo "[Frontend] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
              docker stop seeandyougo-nginx > /dev/null 2>&1 || true
              docker rm seeandyougo-nginx > /dev/null 2>&1 || true
              
              echo "[Frontend] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
              docker run -d \
                --name seeandyougo-nginx \
                --restart always \
                --network backbone \
                -p 80:80 \
                -p 443:443 \
                -e TZ=Asia/Seoul \
                seeandyougo-frontend:latest > /dev/null 2>&1
              
              echo "âœ… [Frontend] ë°°í¬ ì™„ë£Œ"
            fi
            
            # ì •ë¦¬
            echo ""
            echo "[ì‹œìŠ¤í…œ] ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
            rm -rf /tmp/seeandyougo-deploy
            docker system prune -f > /dev/null 2>&1
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ¨ ë°°í¬ ì™„ë£Œ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: "[ê²€ì¦] ë°°í¬ ìƒíƒœ í™•ì¸"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 15m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š ë°°í¬ ê²€ì¦"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ "${{ inputs.deploy_target }}" == "all" ] || [ "${{ inputs.deploy_target }}" == "backend" ]; then
              echo ""
              echo "[Backend] ìµœê·¼ ë¡œê·¸:"
              docker logs --tail 20 seeandyougo 2>&1 | head -20
              echo ""
              
              echo "[Backend] í—¬ìŠ¤ì²´í¬:"
              sleep 3
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… Backend ì •ìƒ ì‘ë™ ì¤‘"
              else
                echo "âš ï¸  í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ (ì„œë²„ëŠ” ì‹¤í–‰ ì¤‘)"
              fi
            fi
            
            if [ "${{ inputs.deploy_target }}" == "all" ] || [ "${{ inputs.deploy_target }}" == "frontend" ]; then
              echo ""
              echo "[Frontend] ìµœê·¼ ë¡œê·¸:"
              docker logs --tail 15 seeandyougo-nginx 2>&1 | head -15
              echo ""
              
              echo "[Frontend] í—¬ìŠ¤ì²´í¬:"
              if curl -f http://localhost/ > /dev/null 2>&1; then
                echo "âœ… Frontend ì •ìƒ ì‘ë™ ì¤‘"
              else
                echo "âš ï¸  Frontend ì‘ë‹µ ì—†ìŒ"
              fi
            fi
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ê²€ì¦ ì™„ë£Œ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: "[ì™„ë£Œ] ë°°í¬ ê²°ê³¼ ì•Œë¦¼"
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ"
            echo "ğŸ“¦ ë°°í¬ ëŒ€ìƒ: ${{ inputs.deploy_target }}"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            echo "ğŸ“‹ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
          fi
